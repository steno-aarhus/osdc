---
title: "Internal function flow"
execute: 
  eval: false
vignette: >
  %\VignetteIndexEntry{Internal function flow}
  %\VignetteEngine{quarto::html}
  %\VignetteEncoding{UTF-8}
---

This document describes the flow of functions and objects within the
package, specifically within the main exposed function
`classify_diabetes()`. It shows the data sources and how they enter or
are used in the function as well as how the different internal functions
and logic are connected to each other. A high-level overview of the flow
is shown in the diagram below.

::: content-hidden
In the mermaid diagram below, invisible edges (~~~) are used solely
for layout purposes to help position the nodes.
:::

```{mermaid}
%%| eval: true
%%| fig-cap: "Flow of functions in, as well as their required input registers, in the `classify_diabetes()` function used for classifying diabetes status using the osdc package. Light blue and orange boxes represent filtering functions (inclusion and exclusion events, respectively)."

flowchart TD
  subgraph data_sources["Data sources"]
    lpr_diag[("lpr_diag")]
    lpr_adm[("lpr_adm")]
    kontakter[("kontakter")]
    diagnoser[("diagnoser")]
    sysi[("sysi")]
    sssy[("sssy")]
    lmdb[("lmdb")]
    lab_forsker[("lab_forsker")]
    bef[("bef")]
  end

  subgraph classify_diabetes["classify_diabetes()"]

    lpr_diag --> prepare_lpr2["prepare_lpr2()"]
    lpr_adm --> prepare_lpr2

    kontakter --> prepare_lpr3["prepare_lpr3()"]
    diagnoser --> prepare_lpr3

    prepare_lpr2 --> keep_pregnancy_dates["keep_pregnancy_dates()"]
    prepare_lpr3 --> keep_pregnancy_dates

    %% Inclusion steps
    sysi --> include_podiatrist_services["include_podiatrist_services()"]:::include
    sssy --> include_podiatrist_services

    prepare_lpr2 --> include_diabetes_diagnoses["include_diabetes_diagnoses()"]:::include
    prepare_lpr3 --> include_diabetes_diagnoses
    include_diabetes_diagnoses --> add_t1d_diagnoses_cols["add_t1d_diagnoses_cols()"]

    lmdb --> include_gld_purchases["include_gld_purchases()"]:::include

    lab_forsker --> include_hba1c["include_hba1c()"]:::include

    %% Exclusion steps
    include_gld_purchases --> exclude_potential_pcos["exclude_potential_pcos()"]:::exclude
    bef --> exclude_potential_pcos

    exclude_potential_pcos --> exclude_pregnancy["exclude_pregnancy()"]:::exclude
    keep_pregnancy_dates --> exclude_pregnancy
    include_hba1c --> exclude_pregnancy
    exclude_pregnancy --> add_insulin_purchases_cols["add_insulin_purchases_cols()"]

    %% Joining
    add_t1d_diagnoses_cols --> join_inclusions["join_inclusions()"]
    include_podiatrist_services --> join_inclusions
    add_insulin_purchases_cols --> join_inclusions

    join_inclusions --> create_inclusion_dates["create_inclusion_dates()"]
    create_inclusion_dates --> classify_t1d["classify_t1d()"]

    keep_pregnancy_dates ~~~ exclude_potential_pcos

  end

  %% Styling
  classDef default fill:#EEEEEE,color:#000000
  classDef include fill:lightblue
  classDef exclude fill:orange
  style classify_diabetes fill:#FFFFFF,color:#000000
  style data_sources fill:#FFFFFF,color:#000000,stroke-width:0px
```

The sections below are split into functions for inclusion and exclusion
as well as functions for determining the final diagnosis date and
eventual classification of type 1 and type 2 diabetes.

## Inclusion events

-   `prepare_lpr2()`: See `?prepare_lpr2` for more information.
-   `prepare_lpr3()`: See `?prepare_lpr3` for more information.

### `include_diabetes_diagnoses()`

See `?include_diabetes_diagnoses` for more information.

### `include_podiatrist_services()`

See `?include_podiatrist_services` for more information.

### `include_hba1c()`

See `?include_hba1c` for more information.

### `include_gld_purchases()`

See `?include_gld_purchases` for more information.

## Exclusion events

### `exclude_potential_pcos()`

See `?exclude_potential_pcos` for more information.

### `exclude_pregnancy()`

See `?exclude_pregnancy` for more information.

## Joining inclusions and exclusions

### `join_inclusions()`

See `?join_inclusions` for more information.

### Create inclusion dates

See `?create_inclusion_dates` for more information.