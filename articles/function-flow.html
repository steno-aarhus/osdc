<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Internal function flow • osdc</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Internal function flow">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">osdc</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.1.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/osdc.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/algorithm.html">Algorithm</a></li>
    <li><a class="dropdown-item" href="../articles/changes.html">Changes to algorithm</a></li>
    <li><a class="dropdown-item" href="../articles/data-sources.html">Data sources</a></li>
    <li><a class="dropdown-item" href="../articles/design.html">Design</a></li>
    <li><a class="dropdown-item" href="../articles/function-flow.html">Internal function flow</a></li>
    <li><a class="dropdown-item" href="../articles/rationale.html">Rationale</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/steno-aarhus/osdc/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Internal function flow</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/steno-aarhus/osdc/blob/main/vignettes/articles/function-flow.Rmd" class="external-link"><code>vignettes/articles/function-flow.Rmd</code></a></small>
      <div class="d-none name"><code>function-flow.Rmd</code></div>
    </div>

    
    
<p>The function flow describes the functions within the package, both
internal and user-facing, which data sources they rely on, and how they
are connected to each other. First, the functions for classifying
diabetes status are presented, followed by the functions for classifying
the diabetes type.</p>
<div class="section level2">
<h2 id="function-flow">Function flow<a class="anchor" aria-label="anchor" href="#function-flow"></a>
</h2>
<p>This results in the functionality flow for classifying diabetes
status seen below. This flow can be divided into two sections:
extracting the diabetes population and classifying diabetes type which
we will detail in the following sections.</p>
<div class="float">
<img src="function-flow.svg" alt="Flow of functions, as well as their required input registers, for classifying diabetes status using the osdc package. Light blue and orange boxes represent filtering functions (inclusion and exclusion events, respectively). Uncoloured boxes are helper functions that get or extract a condition or joins data or function outputs."><div class="figcaption">Flow of functions, as well as their required
input registers, for classifying diabetes status using the osdc package.
Light blue and orange boxes represent filtering functions (inclusion and
exclusion events, respectively). Uncoloured boxes are helper functions
that get or extract a condition or joins data or function outputs.</div>
</div>
</div>
<div class="section level2">
<h2 id="population-extraction">Population extraction<a class="anchor" aria-label="anchor" href="#population-extraction"></a>
</h2>
<p>In the following sections, we describe the functions used to extract
the diabetes population from the Danish registers. The functions are
divided into inclusion and exclusion events, and the final diagnosis
date is calculated based on these events.</p>
<div class="float">
<img src="function-flow-population.svg" alt="Flow of functions, as well as their required input registers, for extracting the population with diabetes using the osdc package. Light blue and orange boxes represent filtering functions (inclusion and exclusion events, respectively). Uncoloured boxes are helper functions that get or extract a condition or joins data or function outputs."><div class="figcaption">Flow of functions, as well as their required
input registers, for extracting the population with diabetes using the
osdc package. Light blue and orange boxes represent filtering functions
(inclusion and exclusion events, respectively). Uncoloured boxes are
helper functions that get or extract a condition or joins data or
function outputs.</div>
</div>
</div>
<div class="section level2">
<h2 id="inclusion-events">Inclusion events<a class="anchor" aria-label="anchor" href="#inclusion-events"></a>
</h2>
<ul>
<li>
<code><a href="../reference/prepare_lpr2.html">prepare_lpr2()</a></code>: See <code><a href="../reference/prepare_lpr2.html">?prepare_lpr2</a></code> for more
information.</li>
<li>
<code><a href="../reference/prepare_lpr3.html">prepare_lpr3()</a></code>: See <code><a href="../reference/prepare_lpr3.html">?prepare_lpr3</a></code> for more
information.</li>
</ul>
<div class="section level3">
<h3 id="include_diabetes_diagnoses">
<code>include_diabetes_diagnoses()</code><a class="anchor" aria-label="anchor" href="#include_diabetes_diagnoses"></a>
</h3>
<p>See <code><a href="../reference/include_diabetes_diagnoses.html">?include_diabetes_diagnoses</a></code> for more
information.</p>
</div>
<div class="section level3">
<h3 id="include_podiatrist_services">
<code>include_podiatrist_services()</code><a class="anchor" aria-label="anchor" href="#include_podiatrist_services"></a>
</h3>
<p>See <code><a href="../reference/include_podiatrist_services.html">?include_podiatrist_services</a></code> for more
information.</p>
</div>
<div class="section level3">
<h3 id="include_hba1c">
<code>include_hba1c()</code><a class="anchor" aria-label="anchor" href="#include_hba1c"></a>
</h3>
<p>See <code><a href="../reference/include_hba1c.html">?include_hba1c</a></code> for more information.</p>
</div>
<div class="section level3">
<h3 id="include_gld_purchases">
<code>include_gld_purchases()</code><a class="anchor" aria-label="anchor" href="#include_gld_purchases"></a>
</h3>
<p>See <code><a href="../reference/include_gld_purchases.html">?include_gld_purchases</a></code> for more information.</p>
</div>
</div>
<div class="section level2">
<h2 id="exclusion-events">Exclusion events<a class="anchor" aria-label="anchor" href="#exclusion-events"></a>
</h2>
<div class="section level3">
<h3 id="exclude_potential_pcos">
<code>exclude_potential_pcos()</code><a class="anchor" aria-label="anchor" href="#exclude_potential_pcos"></a>
</h3>
<p>See <code><a href="../reference/exclude_potential_pcos.html">?exclude_potential_pcos</a></code> for more information.</p>
</div>
<div class="section level3">
<h3 id="exclude_pregnancy">
<code>exclude_pregnancy()</code><a class="anchor" aria-label="anchor" href="#exclude_pregnancy"></a>
</h3>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Exclude any pregnancy events that could be gestational diabetes.</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' The function `exclude_pregnancy()` takes the combined outputs from</span></span>
<span><span class="co">#' `prepare_lpr2()`, `prepare_lpr3()`, `include_hba1c()`, and</span></span>
<span><span class="co">#' `exclude_potential_pcos()` and uses diagnoses from LPR2 or LPR3 to</span></span>
<span><span class="co">#' exclude both elevated HbA1c tests and GLD purchases during pregnancy, as</span></span>
<span><span class="co">#' these may be due to gestational diabetes, rather than type 1 or type 2</span></span>
<span><span class="co">#' diabetes. The aim is to identify pregnancies based on diagnosis codes</span></span>
<span><span class="co">#' specific to pregnancy-ending events (e.g. live births or miscarriages),</span></span>
<span><span class="co">#' and then use the dates of these events to remove inclusion events in the</span></span>
<span><span class="co">#' preceding months that may be related to gestational diabetes (e.g.</span></span>
<span><span class="co">#' elevated HbA1c tests or purchases of glucose-lowering drugs during</span></span>
<span><span class="co">#' pregnancy).</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' After these exclusion functions have been applied, the output serves as</span></span>
<span><span class="co">#' inputs to two sets of functions:</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' 1.  The censored HbA1c and GLD data are passed to the</span></span>
<span><span class="co">#'     `join_inclusions()` function for the final step of the inclusion</span></span>
<span><span class="co">#'     process.</span></span>
<span><span class="co">#' 2.  the censored GLD data is passed to the</span></span>
<span><span class="co">#'     `get_only_insulin_purchases()`,</span></span>
<span><span class="co">#'     `get_insulin_purchases_within_180_days()`, and</span></span>
<span><span class="co">#'     `get_insulin_is_two_thirds_of_gld_doses()` helper functions for the</span></span>
<span><span class="co">#'     classification of diabetes type.</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @param excluded_pcos Output from `exclude_potential_pcos()`.</span></span>
<span><span class="co">#' @param pregnancy_dates Output from `get_pregnancy_dates()`.</span></span>
<span><span class="co">#' @param included_hba1c Output from `include_hba1c()`.</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @returns The same type as the input data, default as a [tibble::tibble()].</span></span>
<span><span class="co">#'    Has the same output data as the input `excluded_potential_pcos()`, except</span></span>
<span><span class="co">#'    for a helper logical variable `no_pregnancy` that is used in later functions.</span></span>
<span><span class="co">#' @keywords internal</span></span>
<span><span class="co">#' @inherit algorithm seealso</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @examples</span></span>
<span><span class="co">#' register_data &lt;- simulate_registers(c(</span></span>
<span><span class="co">#'   "lmdb", "bef", "lpr_diag", "lpr_adm",</span></span>
<span><span class="co">#'   "diagnoser", "kontakter", "lab_forsker"</span></span>
<span><span class="co">#' ))</span></span>
<span><span class="co">#' lpr2 &lt;- prepare_lpr2(register_data$lpr_diag, register_data$lpr_adm)</span></span>
<span><span class="co">#' lpr3 &lt;- join_lpr3(register_data$diagnoser, register_data$kontakter)</span></span>
<span><span class="co">#' lmdb |&gt;</span></span>
<span><span class="co">#'   include_gld_purchases() |&gt;</span></span>
<span><span class="co">#'   exclude_potential_pcos(register_data$bef) |&gt;</span></span>
<span><span class="co">#'   exclude_pregnancy(</span></span>
<span><span class="co">#'     get_pregnancy_dates(lpr2, lpr3),</span></span>
<span><span class="co">#'     include_hba1c(register_data$lab_forsker)</span></span>
<span><span class="co">#'   )</span></span>
<span><span class="va">exclude_pregnancy</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">excluded_pcos</span>, <span class="va">pregnancy_dates</span>, <span class="va">included_hba1c</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Filter using the algorithm for pregnancy</span></span>
<span>  <span class="va">excluded_pcos</span> <span class="op">|&gt;</span></span>
<span>    <span class="co"># Exclude those who are not pregnant.</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">full_join</a></span><span class="op">(</span><span class="va">pregnancy_dates</span>, by <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html" class="external-link">join_by</a></span><span class="op">(</span><span class="va">.data</span><span class="op">$</span><span class="va">pnr</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">full_join</a></span><span class="op">(</span><span class="va">included_hba1c</span>, by <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html" class="external-link">join_by</a></span><span class="op">(</span><span class="va">.data</span><span class="op">$</span><span class="va">pnr</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="co"># Filtering here...</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>no_pregnancy <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Simple function to get only the pregnancy event dates.</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @param lpr2 Output from `prepare_lpr2()`.</span></span>
<span><span class="co">#' @param lpr3 Output from `prepare_lpr3()`.</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @returns The same type as the input data, default as a [tibble::tibble()].</span></span>
<span><span class="co">#' @keywords internal</span></span>
<span><span class="co">#' @inherit algorithm seealso</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @examples</span></span>
<span><span class="co">#' register_data &lt;- simulate_registers(c("lpr_diag", "lpr_adm", "diagnoser", "kontakter"), 100)</span></span>
<span><span class="co">#' lpr2 &lt;- prepare_lpr2(register_data$lpr_diag, register_data$lpr_adm)</span></span>
<span><span class="co">#' lpr3 &lt;- prepare_lpr3(register_data$diagnoser, register_data$kontakter)</span></span>
<span><span class="co">#' get_pregnancy_dates(lpr2, lpr3)</span></span>
<span><span class="va">get_pregnancy_dates</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">lpr2</span>, <span class="va">lpr3</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Filter using the algorithm for pregnancy</span></span>
<span>  <span class="va">lpr2</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">full_join</a></span><span class="op">(</span><span class="va">lpr3</span>, by <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html" class="external-link">join_by</a></span><span class="op">(</span><span class="va">pnr</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">has_pregnancy_events</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span></span>
<span>      <span class="va">pnr</span>,</span>
<span>      pregnancy_event_date <span class="op">=</span> <span class="va">date</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="joining-inclusions-and-exclusions">Joining inclusions and exclusions<a class="anchor" aria-label="anchor" href="#joining-inclusions-and-exclusions"></a>
</h2>
<div class="section level3">
<h3 id="join_inclusions">
<code>join_inclusions()</code><a class="anchor" aria-label="anchor" href="#join_inclusions"></a>
</h3>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Join included events.</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' This function joins the outputs from all the inclusion and exclusion</span></span>
<span><span class="co">#' functions, by `pnr` and `dates`. Input datasets:</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' - `included_diabetes_diagnoses`: Dates are the first and second hospital diabetes diagnosis.</span></span>
<span><span class="co">#' - `included_podiatrist_services`: Dates are the first and second diabetes-specific podiatrist record.</span></span>
<span><span class="co">#' - `hba1c_censored_pregnancy`: Dates are the first and second elevated HbA1c test results (after censoring potential gestational diabetes).</span></span>
<span><span class="co">#' - `gld_censored_pcos_pregnancy`: Dates are the first and second purchase of a glucose-lowering drug (after censoring potential polycystic ovary syndrome and gestational diabetes).</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @param included_diabetes_diagnoses Output from [include_diabetes_diagnoses()].</span></span>
<span><span class="co">#' @param included_podiatrist_services Output from [include_podiatrist_services()].</span></span>
<span><span class="co">#' @param hba1c_censored_pregnancy Output from [exclude_pregnancy()] when given `hba1c` data.</span></span>
<span><span class="co">#' @param gld_censored_pcos_pregnancy Output from [exclude_pregnancy()] when given `gld_censored_pcos` data.</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @returns The same type as the input data, default as a [tibble::tibble()],</span></span>
<span><span class="co">#'   with the joined columns from the output of [include_diabetes_diagnoses()],</span></span>
<span><span class="co">#'   [include_podiatrist_services()] and [exclude_pregnancy()]. There will be </span></span>
<span><span class="co">#'   1-8 rows per `pnr`.</span></span>
<span><span class="co">#' @keyword internal</span></span>
<span><span class="co">#' @inherit algorithm seealso</span></span>
<span><span class="va">join_inclusions</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span></span>
<span>    <span class="va">included_diabetes_diagnoses</span>,</span>
<span>    <span class="va">included_podiatrist_services</span>,</span>
<span>    <span class="va">hba1c_censored_pregnancy</span>,</span>
<span>    <span class="va">gld_censored_pcos_pregnancy</span></span>
<span>    <span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Combine the outputs from the inclusion and exclusion events</span></span>
<span>  <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/reduce.html" class="external-link">reduce</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      <span class="va">included_diabetes_diagnoses</span>,</span>
<span>      <span class="va">included_podiatrist_services</span>,</span>
<span>      <span class="va">excluded_pregnancy</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="co"># This joins *only* by pnr and dates. If datasets have the same column</span></span>
<span>    <span class="co"># names, they will be renamed to differentiate them.</span></span>
<span>    <span class="co"># TODO: We may need to ensure that no two datasets have the same columns.</span></span>
<span>    \<span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">full_join</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, by <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html" class="external-link">join_by</a></span><span class="op">(</span><span class="va">.data</span><span class="op">$</span><span class="va">pnr</span>, <span class="va">.data</span><span class="op">$</span><span class="va">dates</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="create-inclusion-dates">Create inclusion dates<a class="anchor" aria-label="anchor" href="#create-inclusion-dates"></a>
</h3>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Create the final diagnosis date based on all the inclusion event types.</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' The function `create_inclusion_dates()` takes the output from `join_inclusions()`</span></span>
<span><span class="co">#' and defines the final diagnosis date based on all the inclusion event types.</span></span>
<span><span class="co">#' Keeps only those with 2 or more recorded inclusion events, regardless of the</span></span>
<span><span class="co">#' type of these events (e.g. two elevated HbA1c tests will lead to inclusion as</span></span>
<span><span class="co">#' well as one elevated HbA1c test followed by a purchase of glucose-lowering</span></span>
<span><span class="co">#' drugs).</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @param inclusions Output from [join_inclusions()].</span></span>
<span><span class="co">#' @param stable_inclusion_start_date The date from when the inclusion events</span></span>
<span><span class="co">#'    from all sources are considered more 'stable' (e.g. time after the change</span></span>
<span><span class="co">#'    in how medication drugs are labeled and how doctors actually regularly</span></span>
<span><span class="co">#'    input the new change into the database).</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @returns The same type as the input data, default as a [tibble::tibble()],</span></span>
<span><span class="co">#'   along with the `purchase_date`, `atc`, `contained_doses` columns from</span></span>
<span><span class="co">#'   `exclude_pregnancy()`, and the `n_t1d_endocrinology`,</span></span>
<span><span class="co">#'   `n_t2d_endocrinology`, `n_t1d_medical`, and `n_t2d_medical` columns from</span></span>
<span><span class="co">#'   `include_diabetes_diagnoses()`. It also creates two new columns:</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#'   - `raw_inclusion_date`: Date of inclusion, which is the second</span></span>
<span><span class="co">#'      earliest recorded event.</span></span>
<span><span class="co">#'   - `stable_inclusion_date`: Date of inclusion of individuals included</span></span>
<span><span class="co">#'      at least one year after the incorporation of inclusions based on</span></span>
<span><span class="co">#'      glucose-lowering drug data (1998 onwards when using National Patient</span></span>
<span><span class="co">#'      Register data for censoring of gestational diabetes). Limits the</span></span>
<span><span class="co">#'      included cohort to only individuals with a valid date of inclusion</span></span>
<span><span class="co">#'      (and thereby valid age at inclusion &amp; duration of diabetes).</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @keywords internal</span></span>
<span><span class="co">#' @inherit algorithm seealso</span></span>
<span><span class="va">create_inclusion_dates</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">inclusions</span>, <span class="va">stable_inclusion_start_date</span> <span class="op">=</span> <span class="st">"1998-01-01"</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">inclusions</span> <span class="op">|&gt;</span></span>
<span>    <span class="co"># TODO: May need to consider more efficient ways than using group by.</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">.data</span><span class="op">$</span><span class="va">pnr</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="co"># Drop earliest date so only those with two or more events are included.</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">.data</span><span class="op">$</span><span class="va">dates</span> <span class="op">!=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">.data</span><span class="op">$</span><span class="va">dates</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>      <span class="co"># Earliest date in the rows for each individual.</span></span>
<span>      raw_inclusion_date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">.data</span><span class="op">$</span><span class="va">dates</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>      stable_inclusion_date <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span></span>
<span>        <span class="va">.data</span><span class="op">$</span><span class="va">raw_inclusion_date</span> <span class="op">&lt;</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/as_date.html" class="external-link">as_date</a></span><span class="op">(</span><span class="va">stable_inclusion_start_date</span><span class="op">)</span>,</span>
<span>        <span class="cn">NA</span>,</span>
<span>        <span class="va">.data</span><span class="op">$</span><span class="va">raw_inclusion_date</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span></span>
<span>      <span class="st">"pnr"</span>,</span>
<span>      <span class="st">"raw_inclusion_date"</span>,</span>
<span>      <span class="st">"stable_inclusion_date"</span>,</span>
<span></span>
<span>      <span class="co"># From `exclude_pregnancy()` via the GLD purchases</span></span>
<span>      <span class="co"># TODO: this might need to be renamed in a previous step, rather than here.</span></span>
<span>      <span class="st">"purchase_date"</span> <span class="op">=</span> <span class="st">"date"</span>,</span>
<span>      <span class="st">"atc"</span>,</span>
<span>      <span class="st">"contained_doses"</span>,</span>
<span></span>
<span>      <span class="co"># From `include_diabetes_diagnoses()`</span></span>
<span>      <span class="st">"n_t1d_endocrinology"</span>,</span>
<span>      <span class="st">"n_t2d_endocrinology"</span>,</span>
<span>      <span class="st">"n_t1d_medical"</span>,</span>
<span>      <span class="st">"n_t2d_medical"</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="classifying-the-diabetes-type">Classifying the diabetes type<a class="anchor" aria-label="anchor" href="#classifying-the-diabetes-type"></a>
</h3>
<p>The next step of the OSDC algorithm classifies individuals from the
extracted diabetes population as having either T1D or T2D. As described
in the <code>vignette("design")</code>, individuals not classified as
T1D cases are classified as T2D cases.</p>
<p>As the diabetes type classification incorporates an evaluation of the
time from diagnosis/inclusion to first subsequent purchase of insulin,
the <code>get_diabetes_type()</code> function has to take the date of
diagnosis and all purchases of GLD drugs (after censoring) as inputs. In
addition, information on diabetes type-specific primary diagnoses from
hospitals is also needed, which is provided by
<code>count_primary_diagnoses_by_department()</code>.</p>
<p>Thus, the function takes the following inputs from
<code>get_inclusion_date()</code>, <code><a href="../reference/exclude_pregnancy.html">exclude_pregnancy()</a></code>, and
<code>count_primary_diagnoses_by_department</code>:</p>
<ul>
<li>From <code>get_inclusion_date()</code>: Information on date of
diagnosis of diabetes
<ul>
<li><code>pnr</code></li>
<li><code>raw_inclusion_date</code></li>
<li><code>stable_inclusion_date</code></li>
</ul>
</li>
<li>From <code><a href="../reference/exclude_pregnancy.html">exclude_pregnancy()</a></code>: Information on historic GLD
purchases:
<ul>
<li>
<code>pnr</code>: identifier variable</li>
<li>
<code>date</code>: dates of all purchases of GLD.</li>
<li>
<code>atc</code>: type of drug</li>
<li>
<code>contained_doses</code>: defined daily doses of drug contained
in purchase</li>
</ul>
</li>
<li>From <code>count_primary_diagnoses_by_department</code>: Information
on diabetes type-specific primary diagnoses from hospitals:
<ul>
<li>
<code>pnr</code>: identifier variable</li>
<li>
<code>n_t1d_endocrinology</code>: number of type 1 diabetes-specific
primary diagnosis codes from endocrinological departments</li>
<li>
<code>n_t2d_endocrinology</code>: number of type 2 diabetes-specific
primary diagnosis codes from endocrinological departments</li>
<li>
<code>n_t1d_medical</code>: number of type 1 diabetes-specific
primary diagnosis codes from medical departments</li>
<li>
<code>n_t2d_medical</code>: number of type 2 diabetes-specific
primary diagnosis codes from medical departments</li>
</ul>
</li>
</ul>
<p>For each <code>pnr</code> number, several helper functions are
applied to these inputs to extract additional information from the
censored GLD data and diagnoses to use for classification of diabetes
type. All of these return a single value (<code>TRUE</code>, otherwise
<code>FALSE</code>) for each individual:</p>
<ul>
<li>
<code>get_only_insulin_purchases()</code>:
<ul>
<li>Inputs passed from <code><a href="../reference/exclude_pregnancy.html">exclude_pregnancy()</a></code>:
<ul>
<li><code>atc</code></li>
</ul>
</li>
<li>Outputs:
<ul>
<li>only_insulin_purchases = <code>TRUE</code> if no purchases with
<code>atc</code> starting with “A10A” are present</li>
</ul>
</li>
</ul>
</li>
<li>
<code>get_insulin_purchases_within_180_days()</code>
<ul>
<li>Inputs passed from <code><a href="../reference/exclude_pregnancy.html">exclude_pregnancy()</a></code>:
<ul>
<li>
<code>date</code> &amp; <code>atc</code>
</li>
</ul>
</li>
<li>Inputs passed from <code>get_inclusion_date()</code>:
<ul>
<li><code>raw_inclusion_date</code></li>
</ul>
</li>
<li>Outputs: <code>TRUE</code> If any purchases with <code>atc</code>
starting with “A10A” have a <code>date</code> between 0 and 180 days
higher than <code>raw_inclusion_date</code>
</li>
</ul>
</li>
<li>
<code>get_insulin_is_two_thirds_of_gld_doses()</code>
<ul>
<li>Inputs passed from <code><a href="../reference/exclude_pregnancy.html">exclude_pregnancy()</a></code>:
<ul>
<li>
<code>contained_doses</code> &amp; <code>atc</code>
</li>
</ul>
</li>
<li>Outputs: <code>TRUE</code> If the sum of
<code>contained_doses</code> of rows of <code>atc</code> starting with
“A10A” (except “A10AE5”) is at least twice the sum of
<code>contained_doses</code> of rows of <code>atc</code> starting with
“A10B” or “A10AE5”</li>
</ul>
</li>
<li>
<code>get_any_t1d_primary_diagnoses()</code>:
<ul>
<li>Inputs passed from <code><a href="../reference/include_diabetes_diagnoses.html">include_diabetes_diagnoses()</a></code>:
<ul>
<li>
<code>n_t1d_endocrinology</code> &amp;
<code>n_t1d_medical</code>
</li>
</ul>
</li>
<li>Outputs: <code>TRUE</code> if the combined sum of the inputs is 1 or
above.</li>
</ul>
</li>
<li>
<code>get_type_diagnoses_from_endocrinology()</code>:
<ul>
<li>Inputs passed from <code><a href="../reference/include_diabetes_diagnoses.html">include_diabetes_diagnoses()</a></code>:
<ul>
<li>
<code>n_t1d_endocrinology</code>,
<code>n_t2d_endocrinology</code>
</li>
</ul>
</li>
<li>Outputs: <code>type_diagnoses_from_endocrinology</code> =
<code>TRUE</code> if the combined sum of the inputs is 1 or above</li>
</ul>
</li>
<li>
<code>get_type_diagnosis_majority()</code>:
<ul>
<li>Inputs passed from <code><a href="../reference/include_diabetes_diagnoses.html">include_diabetes_diagnoses()</a></code>:
<ul>
<li>
<code>n_t1d_endocrinology</code>, <code>n_t2d_endocrinology</code>,
<code>n_t1d_medical</code> &amp; <code>n_t2d_medical</code>
</li>
</ul>
</li>
<li>Inputs passed from
<code>get_type_diagnoses_from_endocrinology()</code>:
<ul>
<li><code>type_diagnoses_from_endocrinology</code></li>
</ul>
</li>
<li>Outputs: <code>TRUE</code> if
<code>type_diagnoses_from_endocrinology</code> == <code>TRUE</code> and
<code>n_t1d_endocrinology</code> is above
<code>n_t2d_endocrinology</code>. Also <code>TRUE</code> if
<code>type_diagnoses_from_endocrinology</code> = <code>FALSE</code> and
<code>n_t1d_medical</code> is above <code>n_t2d_medical</code>
</li>
</ul>
</li>
</ul>
<p><code>get_diabetes_type()</code> evaluates all the outputs from the
helper functions to define diabetes type for each individual. Diabetes
type is classified as “T1D” if:</p>
<ul>
<li>
<code>only_insulin_purchases</code> == <code>TRUE</code> &amp;
<code>any_t1d_primary_diagnoses</code> == <code>TRUE</code>
</li>
<li>Or <code>only_insulin_purchases</code> == <code>FALSE</code> &amp;
<code>any_t1d_primary_diagnoses</code> == <code>TRUE</code> &amp;
<code>type_diagnosis_majority</code> == <code>TRUE</code> &amp;
<code>insulin_is_two_thirds_of_gld_doses</code> == <code>TRUE</code>
&amp; <code>insulin_purchases_within_180_days</code> ==
<code>TRUE</code>
</li>
</ul>
<p><code>get_diabetes_type()</code> returns a <code>data.frame</code>
with one row per <code>pnr</code> number and four columns:
<code>pnr</code>, <code>stable_inclusion_date</code>,
<code>raw_inclusion_date</code> &amp; <code>diabetes_type</code>. This
is the final product of the OSDC algorithm. See the
<code>vignette("design")</code> for an more detail on the two inclusion
dates and their intended use-cases.</p>
<!-- TODO: Create updated image similar to https://aastedet.github.io/dissertation/4-results.html#fig-osdc-type-flow to reflect the new diabetes type logic and embed image here for reference-->
<!-- TODO:  The following explanatory sections on T1D and T2D classification need to be aligned with the technical sections above, and possibly moved up to them-->
<div class="float">
<img src="function-flow-classification.svg" alt="Flow of functions for classifying diabetes status using the osdc package."><div class="figcaption">Flow of functions for classifying diabetes
status using the <code>osdc</code> package.</div>
</div>
<div class="section level4">
<h4 id="type-1-classification">Type 1 classification<a class="anchor" aria-label="anchor" href="#type-1-classification"></a>
</h4>
<p>The details for the classification of type 1 diabetes is described in
<code>vignette("design")</code>. To classify whether an individual has
T1D, the OSDC algorithm includes the following criteria:</p>
<ol style="list-style-type: decimal">
<li>
<code>get_t1d_primary_diagnosis()</code>, which relies on the
hospital diagnoses extracted from <code>lpr_diag</code> (LPR2) and
<code>diagnoser</code> (LPR3) in the previous steps.</li>
<li>
<code>get_only_insulin_purchases()</code> which relies on the GLD
purchases from Lægemiddeldatabasen to get patients where all GLD
purchases are insulin only.</li>
<li>
<code>get_majority_of_t1d_diagnoses()</code> (as compared to T2D
diagnoses) which again relies on primary hospital diagnoses from
LPR.</li>
<li>
<code>get_insulin_purchase_within_180_days()</code> which relies on
both diagnosis from LPR and GLD purchases from Lægemiddeldatabasen.</li>
<li>
<code>get_insulin_is_two_thirds_of_gld_doses</code> which relies on
the GLD purchases from Lægemiddeldatabasen.</li>
</ol>
<p>Note the following hierarchy in first function above: First, the
function checks whether the individual has primary diagnoses from
endocrinological specialty. If that’s the case for a given person, the
check of whether they have a majority of T1D primary diagnoses are based
on data from endocrinological specialty. If that’s not the case, the
check will be based on primary diagnoses from medical specialties.</p>
</div>
<div class="section level4">
<h4 id="type-2-classification">Type 2 classification<a class="anchor" aria-label="anchor" href="#type-2-classification"></a>
</h4>
<p>As described in the <code>vignette("design")</code>, individuals not
classified as type 1 cases are classified as type 2 cases.</p>
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Luke William Johnston, Signe Kirk Brødbæk, Anders Aasted Isaksen.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
